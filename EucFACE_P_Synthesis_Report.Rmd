---
title: "EucFACE P Synthesis"
author: "Mingkai Jiang"
date: "1/24/2018"
output:
  html_document: default
---


# 1. Description

This is the progress report of the EucFACE phosphorus (P) synthesis project. All results presented in this report is automatically linked with the code and the data. 

This file attempts to summarize P-related pools, fluxes, concentrations, their treatment and inter-ring variability, and their temporal patterns. 

The objective of this project is to have a proper account of the P balance for the EucFACE experiment, and to investigate the P by CO2 interactions over time (if enough data is available).

All the data used in this study are available at HIEv (at least that's the goal). 


# 2. Methods
### 2.1 Procedure
This procedure is a snapshot of the work. It might be easier just to follow the codes. 

    - Create a list of variables for the P synthesis.
    - For each variable, only consider ring, date, and sometimes depth as independent factors.
    - Calculate P concentrations first.
    - With Carbon balance project, calculate P pools and fluxes.
    - Calculate P budgeting variables, e.g. total standing P stock, P retranslocation coefficient, etc.
    - Make summary tables.
    - Interpret data, e.g. time-series trend, treatment effect, extreme response point, etc. 

### 2.2 Variables
Here, I am summarizing all the P-related pool, flux and concentration variables. 
Currently, this list is in-comprehensive. Will update continuously as the project proceeds. 

    - Soil P concentration and pool (different chemical forms and accessibilities)
    - Microbial P concentration and pool
    - Mycorrhizal P concentration and pool
    - Canopy P concentration, production and pool
    - Wood P concentration, production and pool
    - Fineroot P concentration, production and pool
    - Litterfall P concentration and production
    - P mineralization rate
    - Frass P concentration and production
    - Understorey P concentration, production and pool
    - Standing P stock
    - P requirement
    - Total P retranslocation 
    - Leaf P retranslocation coefficient
    - P uptake
    - P uptake / requirement
    - MRT
    - Standing PUE
    

# 3. P concentration calculations. 
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### source the functions to start the calculations.
    source("programs/prepare.R")
    
    ### assign aco2 and eco2 rings
    aCO2_rings <- c(2,3,6)
    eCO2_rings <- c(1,4,5)

```

### 3.1 Canopy P concentration
Canopy P concentration summarized by ring over the experimental period:
``` {r, echo=FALSE}
    ### calculate the variable
    canopy_p_concentration <- make_canopy_p_concentration()
    
    ### make the ring over date plot
    p <- ggplot(canopy_p_concentration,
                aes(Date, PercP, color=factor(Ring))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Canopy P Concentration (%)")
    plot(p)

```

Canopy P concentration summarized by CO2 treatment over the experimental period:
``` {r, echo=FALSE}
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        canopy_p_concentration[canopy_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        canopy_p_concentration[canopy_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(canopy_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Canopy P Concentration (%)")
    plot(p)

```

Visually, there is **no** CO2 treatment effect. 



### 3.2 Wood P concentration
Wood P concentration summarized by treatment, and we only have one date:

``` {r, echo=FALSE}
    ### calculate the variable
    wood_p_concentration <- make_wood_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        wood_p_concentration[wood_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        wood_p_concentration[wood_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(wood_p_concentration,
                aes(CO2, PercP)) +   
            geom_point(size = 5) +
            xlab("Treatment") + ylab("Wood P Concentration (%)")
    plot(p)

```

Visually, we can't distinguish the difference between CO2 treatment.



### 3.3 Fine root P concentration

There are multiple depths (i.e. 0-10cm, 10-30cm), currently we are averaging the concentrations over depths. 

Fineroot P concentration summarized by treatment over time:

``` {r, echo=FALSE}
    ### calculate the variable
    fineroot_p_concentration <- make_fineroot_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        fineroot_p_concentration[fineroot_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        fineroot_p_concentration[fineroot_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(fineroot_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Fineroot P Concentration (%)")
    plot(p)

```


### 3.4 Leaflitter P concentration
Measurements are taken for both scenesced leaves and leaflitter. 
Scenesced leaves are defined as those that are still (barely) attached to the tree, so there is a tree ID associated with each measurement. 
Leaflitter are those collected from the litter baskets.

Note, these samples were not taken on the same date; nor were they taken on the same dates as the fresh green leaves. 

We firstly need to distinguish the difference between the two. 

``` {r, echo=FALSE, warning=FALSE}
    df <- read.csv("download/FACE_P0020_RA_leafP-Eter_20130201-20151115_L1.csv")
    
    ### setting up the date
    df$Date <- paste0("1-", as.character(df$Campaign))
    df$Date <- as.Date(df$Date, "%d-%b-%y")
    df.litter <- subset(df, Type == "Leaf litter")
    df.dead <- subset(df, Type == "sceneced leaf")
    myDF <- rbind(df.litter, df.dead)

    ### plot
    p <- ggplot(myDF,
                aes(Date, PercP, color=factor(Type))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Leaflitter P Concentration (%)")
    plot(p)
```

Next, both leaflitter and senesced leaves were grouped together as leaflitter. 
The CO2 by date plot is:
``` {r, echo=FALSE}
    ### calculate the variable
    leaflitter_p_concentration <- make_leaflitter_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(leaflitter_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Leaflitter P Concentration (%)")
    plot(p)

```


### 3.5 Understorey P concentration
There are two understorey species: Cymbopogon refractus and Microlaena stipoides. We need to differentiate P concentration difference between the two, as we don't have their relative abundance information. 

``` {r, echo=FALSE} 
    ### read in the file
    df <- read.csv("download/FACE_P0019_RA_leafP-understory_20130509-20151030_L1.csv")
    
    ### Assign date format
    df$Date <- as.Date(df$Date, "%d-%b-%y")
    
    ### Plot species comparisons
    p <- ggplot(df,
            aes(Date, PercP, color=factor(Species))) +   
        geom_point(size = 5) +
        xlab("Date") + ylab("Understorey P Concentration (%)")
    plot(p)
```

Now, we can group both species together and plot understorey P concentration over time.
``` {r, echo=FALSE} 
    understorey_p_concentration <- make_understorey_p_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        understorey_p_concentration[understorey_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        understorey_p_concentration[understorey_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(understorey_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Understorey P Concentration (%)")
    plot(p)

```

### 3.6 Frass P concentration
Frass production 

``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    frass_p_concentration <- make_frass_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        frass_p_concentration[frass_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        frass_p_concentration[frass_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(frass_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Frass P Concentration (%)")
    plot(p)

```

Frass production has a great time-series record of P concentration data available. We may be able to compute its CO2 by time trend and check its statistical significance. 



### 3.7 Microbial P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    microbial_p_concentration <- make_microbial_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        microbial_p_concentration[microbial_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        microbial_p_concentration[microbial_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(microbial_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Microbial P Concentration (%)")
    plot(p)

```
Note, this is based on 0-10cm data only, as this is the only depth with data available. It's not consistent with any other soil related variables (0-30cm). 

### 3.8 Soil P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    soil_p_concentration <- make_soil_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_p_concentration[soil_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_p_concentration[soil_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(soil_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P Concentration (%)")
    plot(p)

```

Note, soil data are available at various depths (0-10, 10-20 and 20-30cm), and data were not collected for all depths at different time points. 
``` {r, echo=FALSE} 

    soil_c_pool <- make_soil_c_pool()
    ### make the depth over date plot
    p <- ggplot(soil_c_pool,
                aes(Date, TotC, color=factor(Depth))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil C Pool at various depth")
    plot(p)
```

It is observed from the above C pool at various depths that, only two dates have C pool measured over three depths. We need to come up with a way to either extrapolate based on depth profile or to remove dates without 3-depth measurements. 

### 3.9 Soil Phosphate P concentration
Averaged across multiple depths, without consideration of assigning relative weight score. Need to update this calculation later. 

Also, soil phosphate P is the PO4-P, not PO4 concentration. 

Further, phosphate measurements were taken at quarterly timestep, but it should not reflect the accumulation of phosphate production over time time frame (I think). But this needs to be confirmed by soil people, as I am not sure whether the measurements excluded plants and mycorrhizaes. Even with exclusion, we still can't be sure this concentration reflects the total soil phosphate production over time period, as rainfall and hence leaching may also affect the concentration. 

``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    soil_phosphate_concentration <- make_soil_phosphate_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_phosphate_concentration[soil_phosphate_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_phosphate_concentration[soil_phosphate_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(soil_phosphate_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P Concentration (%)")
    plot(p)

```

What happens at that time point after 2015? Is it a leaching-induced event?


### 3.10 Mycorrhizal P concentration
We currently don't have mycorrhizal data available yet. 


# 4. P concentration summary table
Below, I summarize the per ring, per treatment table for all P concentration variables. 
Rings 2,3,6 are ambient CO2 rings, and rings 1,4,5 are elevated CO2 rings. 

``` {r, echo=FALSE} 
    source("programs/make_conc_summary_table_by_treatment.R")
    summary_table_concentration_by_treatment <- make_conc_summary_table_by_treatment()
    
    # make the table looks nicer
    colnames(summary_table_concentration_by_treatment)[1] <- "Variable"
    summary_table_concentration_by_treatment[,2:7] <- round(summary_table_concentration_by_treatment[,2:7], 3)
    
    library(knitr)
    kable(summary_table_concentration_by_treatment)

```

<br/>
<br/>

# 5. Important variables. 

### 5.1 Soil bulk density across depths
``` {r, echo=FALSE, warning=FALSE}

    soil_bulk_density <- make_soil_bulk_density()

    ### make the plot
    p <- ggplot(soil_bulk_density,
                aes(ring, bulk_density_kg_m3, color=factor(Depth))) +   
            geom_point(size = 5) +
            xlab("Ring") + ylab("Bulk density (kg m-3)")
    plot(p)


```


### 5.2 Leaf P retranslocation coefficient
We need to think about data collected from the same time point. 




# 6. P pools and fluxes

### 6.1 Soil P pool
``` {r, echo=FALSE, warning=FALSE}

    soil_p_pool <- make_soil_p_pool(p_conc=soil_p_concentration,
                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_p_pool,
                aes(Date, soil_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P pool (g m-2)")
    plot(p)


```

<br/>
<br/>
<br/>
<br/>




# The end.

---
title: "EucFACE P Synthesis"
author: "Mingkai Jiang"
date: "2/2/2018"
output:
  html_document: default
---


# 1. Description

This is a progress report of the EucFACE phosphorus (P) synthesis project. All results presented in this report are linked with the code and the data. 

This file attempts to summarize P-related pools, fluxes, concentrations, their treatment and inter-ring variability, and their temporal patterns. 

The objective of this project is to have a proper account of the P balance for the EucFACE experiment, and to investigate the P by CO2 interaction over time (if enough data is available).

All the data used in this study are available at HIEv (at least that's the goal). 


# 2. Methods
### 2.1 Procedure
This procedure is a snapshot of the work. It might be easier just to follow the codes. 

    - Create a list of variables for the P synthesis.
    - For each variable, only consider ring, date, and sometimes depth as independent factors.
    - Calculate P concentrations first.
    - With carbon/biomass related variables, calculate P pools and fluxes.
    - Calculate P budgeting variables, e.g. total standing P stock, P retranslocation coefficient, etc.
    - Make summary tables.
    - Interpret data, e.g. time-series trend, treatment effect, extreme response point, etc. 

### 2.2 Variables
Here, I am summarizing all the P-related pool, flux and concentration variables. 
Currently, this list is in-comprehensive. Will update continuously as the project proceeds. 

    - Soil P concentration and pool (different chemical forms and accessibilities)
    - Microbial P concentration and pool
    - Mycorrhizal P concentration and pool
    - Canopy P concentration, production and pool
    - Wood P concentration, production and pool
    - Fineroot P concentration, production and pool
    - Coarse root P concentration, production and pool
    - Litterfall P concentration and production
    - P mineralization rate
    - Frass P concentration and production
    - Understorey P concentration, production and pool
    - Standing P stock
    - P requirement
    - Total P retranslocation 
    - Leaf P retranslocation coefficient
    - P uptake
    - P uptake / requirement
    - Mean residence time for P in plants
    - Standing PUE
    
### 2.3 How to derive P pools and fluxes based on concentration

The challenges with the P synthesis project is that, the P concentration measurements are sporadic and infrequent, we cannot simply taking the averages of concentration measurements and multiply it with the biomass data to obtain a P flux. 

For pool variables, i.e. wood P pool, we may be able to get away with using just one concentration measurement, given that the concentration of this pool is rather static and we only have one measurement in time avaiable after all. Taking this into consideration, we need to firstly check if the P concentration for a particular vegetation/soil component is static or not over time. If the P concentration is more or less static, we are fine with using average values to extrapolate. On the other hand, for pools that have rather fluctuating P concentration over time, we probably want to establish some sort of relationship with meteorological data for extrapolation purpose, or try to find the biomass peak and the P concentration associated with this time point, assuming that the product of biomass peak and P concentration returns the highest P pool within this year.  

For fluxes, we also need to see if the concentration is variable over time or not. For those that are more fluctuating with good data coverage, e.g. frass P concentration, we can simply calculate a monthly/quarterly P concentration value and use this value to exrtapolate with biomass changes for its corresponding P fluxes. For those that are fluctuating but with relatively less data coverage and with infrequent measurement frequency, e.g. leaflitter fall P concentration (4 time points over 3 years), we will have to assume the one time point is reflecting the annual P concentration, or otherwise we wouldn't be able to proceed. 

The other way to treat the complexity of variable P concentration over time is make a **sensitivity test**. We can use average P concentration, minimum and maximum P concentrations to respectively calculate the P pools and fluxes. This way we are probably more certain with regard to the range of uncertainties. 



# 3. P concentration calculations. 
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### source the functions to start the calculations.
    source("programs/prepare.R")
    
    ### assign aco2 and eco2 rings
    aCO2_rings <- c(2,3,6)
    eCO2_rings <- c(1,4,5)

```

### 3.1 Canopy P concentration
Canopy P concentration summarized by ring over the experimental period:
``` {r, echo=FALSE}
    ### calculate the variable
    canopy_p_concentration <- make_canopy_p_concentration()
    
    ### make the ring over date plot
    p <- ggplot(canopy_p_concentration,
                aes(Date, PercP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Canopy P Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

Canopy P concentration summarized by CO2 treatment over the experimental period:
``` {r, echo=FALSE}
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        canopy_p_concentration[canopy_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        canopy_p_concentration[canopy_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(canopy_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Canopy P Concentration (%)")
    plot(p)

```

Visually, there is **no** CO2 treatment effect. 



### 3.2 Wood P concentration
Wood P concentration summarized by treatment, and we only have one date:

``` {r, echo=FALSE}
    ### calculate the variable
    wood_p_concentration <- make_wood_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        wood_p_concentration[wood_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        wood_p_concentration[wood_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(wood_p_concentration,
                aes(CO2, PercP)) +   
            geom_point(size = 5) +
            xlab("Treatment") + ylab("Wood P Concentration (%)")
    plot(p)

```

Visually, we can't distinguish the difference between CO2 treatment.



### 3.3 Fine root P concentration

There are multiple depths (i.e. 0-10cm, 10-30cm), currently we are averaging the concentrations over depths. 

Fineroot P concentration summarized by treatment over time:

``` {r, echo=FALSE}
    ### calculate the variable
    fineroot_p_concentration <- make_fineroot_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        fineroot_p_concentration[fineroot_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        fineroot_p_concentration[fineroot_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(fineroot_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Fineroot P Concentration (%)")
    plot(p)

```


### 3.4 Leaflitter P concentration
Measurements are taken for both scenesced leaves and leaflitter. 
Scenesced leaves are defined as those that are still (barely) attached to the tree, so there is a tree ID associated with each measurement. 
Leaflitter are those collected from the litter baskets.

Note, these samples were not taken on the same date; nor were they taken on the same dates as the fresh green leaves. 

We firstly need to distinguish the difference between the two. 

``` {r, echo=FALSE, warning=FALSE}
    df <- read.csv("download/FACE_P0020_RA_leafP-Eter_20130201-20151115_L1.csv")
    
    ### setting up the date
    df$Date <- paste0("1-", as.character(df$Campaign))
    df$Date <- as.Date(df$Date, "%d-%b-%y")
    df.litter <- subset(df, Type == "Leaf litter")
    df.dead <- subset(df, Type == "sceneced leaf")
    myDF <- rbind(df.litter, df.dead)

    ### plot
    p <- ggplot(myDF,
                aes(Date, PercP, color=factor(Type))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Leaflitter P Concentration (%)")
    plot(p)
```

Next, both leaflitter and senesced leaves were grouped together as leaflitter. 
The CO2 by date plot is:
``` {r, echo=FALSE}
    ### calculate the variable
    leaflitter_p_concentration <- make_leaflitter_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(leaflitter_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Leaflitter P Concentration (%)")
    plot(p)

```


### 3.5 Understorey P concentration
There are two understorey species: Cymbopogon refractus and Microlaena stipoides. We need to differentiate P concentration difference between the two, as we don't have their relative abundance information. 

``` {r, echo=FALSE} 
    ### read in the file
    df <- read.csv("download/FACE_P0019_RA_leafP-understory_20130509-20151030_L1.csv")
    
    ### Assign date format
    df$Date <- as.Date(df$Date, "%d-%b-%y")
    
    ### Plot species comparisons
    p <- ggplot(df,
            aes(Date, PercP, color=factor(Species))) +   
        geom_point(size = 5) +
        xlab("Date") + ylab("Understorey P Concentration (%)")
    plot(p)
```

Now, we can group both species together and plot understorey P concentration over time.
``` {r, echo=FALSE} 
    understorey_p_concentration <- make_understorey_p_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        understorey_p_concentration[understorey_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        understorey_p_concentration[understorey_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(understorey_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Understorey P Concentration (%)")
    plot(p)

```

### 3.6 Frass P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    frass_p_concentration <- make_frass_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        frass_p_concentration[frass_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        frass_p_concentration[frass_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(frass_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Frass P Concentration (%)")
    plot(p)

```

Frass production has a great time-series record of P concentration data available. We may be able to compute its CO2 by time trend and check its statistical significance. 



### 3.7 Microbial P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    microbial_p_concentration <- make_microbial_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        microbial_p_concentration[microbial_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        microbial_p_concentration[microbial_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(microbial_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Microbial P Concentration (%)")
    plot(p)

```

Note, this is based on 0-10cm data only, as this is the only depth with data available. It's not consistent with any other soil related variables (0-30cm). 

### 3.8 Soil P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    soil_p_concentration <- make_soil_p_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_p_concentration[soil_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_p_concentration[soil_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(soil_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P Concentration (%)")
    plot(p)

```

Note, soil data are available at various depths (0-10, 10-20 and 20-30cm), and data were not collected for all depths at different time points. 

``` {r, echo=FALSE, warning=FALSE, message=FALSE} 

    soil_bulk_density <- make_soil_bulk_density()
    soil_c_pool <- make_soil_c_pool(soil_bulk_density)

    ### make the depth over date plot
    p <- ggplot(soil_c_pool,
                aes(Date, soil_carbon_pool, color=factor(ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil C Pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

It is observed from the above C pool at various depths that, only two dates have C pool measured over three depths. We need to come up with a way to either extrapolate based on depth profile or to remove dates without 3-depth measurements. 

### 3.9 Soil Phosphate P concentration
Averaged across multiple depths, without consideration of assigning relative weight score. Need to update this calculation later. 

Also, soil phosphate P is the PO4-P, not PO4 concentration. 

Further, phosphate measurements were taken at quarterly timestep, but it should not reflect the accumulation of phosphate production over time time frame (I think). But this needs to be confirmed by soil people, as I am not sure whether the measurements excluded plants and mycorrhizaes. Even with exclusion, we still can't be sure this concentration reflects the total soil phosphate production over time period, as rainfall and hence leaching may also affect the concentration. 

``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### calculate the variable
    soil_phosphate_concentration <- make_soil_phosphate_concentration()
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_phosphate_concentration[soil_phosphate_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_phosphate_concentration[soil_phosphate_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(soil_phosphate_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P Concentration (%)")
    plot(p)

```

Note: Soil PO4 data is only available for top 0-10 cm of the soil!

What happens at that time point after 2015? Is it a leaching-induced event?


### 3.10 Mycorrhizal P concentration
We currently don't have mycorrhizal data available yet. 

# 4. Important variables. 

### 4.1 Soil bulk density across depths
``` {r, echo=FALSE, warning=FALSE}

    soil_bulk_density <- make_soil_bulk_density()

    ### make the plot
    p <- ggplot(soil_bulk_density,
                aes(ring, bulk_density_kg_m3, color=factor(Depth))) +   
            geom_point(size = 5) +
            xlab("Ring") + ylab("Bulk density (kg m-3)")
    plot(p)


```

### 4.2 Soil P mineralization rate
``` {r, echo=FALSE, warning=FALSE}

    soil_p_mineralization <- make_soil_p_mineralization_flux(soil_bulk_density)

    ### make the plot
    # compare eCO2 and aCO2 treatment
    soil_p_mineralization[soil_p_mineralization$ring == 1, "CO2"] <- "eCO2"
    soil_p_mineralization[soil_p_mineralization$ring == 4, "CO2"] <- "eCO2"
    soil_p_mineralization[soil_p_mineralization$ring == 5, "CO2"] <- "eCO2"
    
    soil_p_mineralization[soil_p_mineralization$ring == 2, "CO2"] <- "aCO2"
    soil_p_mineralization[soil_p_mineralization$ring == 3, "CO2"] <- "aCO2"
    soil_p_mineralization[soil_p_mineralization$ring == 6, "CO2"] <- "aCO2"
    
    
    p <- ggplot(soil_p_mineralization, aes(date, p_mineralization_mg_m2_d, color=factor(CO2))) +   
        geom_point(size = 5) +
        xlab("Date") + ylab("P mineralization rate (mg m-2 d-1)") + 
        ggtitle("P mineralization rate over time") 
    plot(p)


```

### 4.3 Leaf P retranslocation coefficient
We need to think about data collected from the same time point. For now, because dates don't match, we just take the averages. 

``` {r, echo=FALSE, warning=FALSE}

    source("programs/make_leaf_p_retranslocation_coefficient.R")
    leaf_p_retrans_coefficient <- make_leaf_p_retranslocation_coefficient()

    p <- ggplot(leaf_p_retrans_coefficient, aes(CO2, retrans_coef, color=factor(Ring))) +   
                geom_point(size = 5) +
                xlab("Treatment") + ylab("Leaf P retranslocation coefficient (%)") 
    plot(p)

```


### 4.4 C fraction for frass production
``` {r, echo=FALSE, warning=FALSE}

    frass_c_fraction <- make_frass_c_fraction()


    ### make the plot
    p <- ggplot(frass_c_fraction,
                aes(Date, frass_c_fraction, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fraction of C in Frass (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 4.5 Aboveground leaf biomass, litterfall and frass production
``` {r, echo = FALSE, warning=FALSE, message=FALSE}
   # hidden variables
    #### Canopy related variables (SLA, LAI, Canopy biomass)
    lai_variable <- make_lai_variable()
    sla_variable <- make_sla_variable()
    canopy_biomass_pool <- make_canopy_biomass_pool(lai_variable, sla_variable)
    
    ### make the plot
    p <- ggplot(canopy_biomass_pool,
                aes(Date, leaf_pool, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Canopy biomass (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    

```


The above figure is a time-series canopy biomass plot, derived based on SLA and LAI measurements. 

Assuming C fraction of 0.5, we can derive the canopy C pool, as:

``` {r, echo=FALSE}
    
    ### make the plot
    p <- ggplot(canopy_biomass_pool,
                aes(Date, leaf_pool*0.5, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Canopy C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

<br/>
Next, I calculate litter fall fluxes:

``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    #### Litter production (leaf, twig, bark, seed)
    litter_c_production_flux <- make_litter_c_flux(c_fraction)

    leaflitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "leaf_flux", "Start_date", "End_date", "Days")]
    twiglitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "twig_flux", "Start_date", "End_date", "Days")]
    barklitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "bark_flux", "Start_date", "End_date", "Days")]
    seedlitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "seed_flux", "Start_date", "End_date", "Days")]
    
    plotDF <- melt(litter_c_production_flux, id.vars = 1:2, measure= 3:6)
    
    ### make the plot
    p <- ggplot(plotDF,
                aes(Date, value, color=factor(variable))) +   
            geom_point(size = 0.5, aes(color=factor(Ring))) + geom_smooth() + 
            xlab("Date") + ylab("Litterfall (mg C m-2 d-1)") 
    plot(p)
    
```

<br/>
Finally, frass production flux is:

``` {r, echo=FALSE, warning=FALSE, message=FALSE}
 
    #### Frass production
    frass_c_production_flux <- make_frass_c_production_flux()

    ### make the plot
    p <- ggplot(frass_c_production_flux,
                aes(Date, frass_production_flux, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Frass C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```


### 4.6 Root biomass and production
First, we calculate fine root c pool: 

``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    #### Fineroot pools and production
    # this is total fineroot biomass for 0-30cm
    # currently implemented whole plant C fraction
    # need to update with fineroot specific C fraction value
    fineroot_c_pool <- make_fineroot_c_pool(c_fraction_fr)
    fineroot_c_production_flux <- make_fineroot_c_production_flux(c_fraction_fr)
    
    ### make the plot
    p <- ggplot(fineroot_c_pool,
                aes(Date, fineroot_pool, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Fineroot C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

<br/>
Fineroot production flux is:

``` {r, echo=FALSE, warning=FALSE, message=FALSE}

    ### make the plot
    p <- ggplot(fineroot_c_production_flux,
                aes(Date, fineroot_production_flux, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Fineroot C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

<br/>

Now, I am comparing coarse root c pools based on two methods. 

Method 1:

``` {r, echo=FALSE, warning=FALSE, message=FALSE}

    coarse_root_c_pool_1 <- make_coarse_root_pool_1(c_fraction, FACE_ring_area) 
    coarse_root_c_pool_2 <- make_coarse_root_pool_2(c_fraction, FACE_ring_area) 
    coarse_root_c_flux_1 <- make_coarse_root_production_flux(coarse_root_c_pool_1) 
    coarse_root_c_flux_2 <- make_coarse_root_production_flux(coarse_root_c_pool_2) 
    
    ### make the plot
    p <- ggplot(coarse_root_c_pool_1,
                aes(Date, coarse_root_pool, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Coarse root C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

<br/>

Method 2:

``` {r, echo=FALSE, warning=FALSE, message=FALSE}

    ### make the plot
    p <- ggplot(coarse_root_c_pool_2,
                aes(Date, coarse_root_pool, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Coarse root C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

Method 2 has slightly higher C pools than method 1. And the inter-ring relationships are not the same. Method 1 is based on both height and diameter and based on Eucalyptus nitens, whereas method 1 is based on diameter information of P. radiata. Hence, here I adopted method 1. 


### 4.7 Understorey C pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    
    #### Understorey aboveground biomass 
    understorey_c_pool <- make_understorey_aboveground_c_pool(c_fraction_ud,
                                                              strip_area)
    
    understorey_c_flux <- make_understorey_aboveground_production_flux(c_fraction_ud)
```


### 4.8 wood C pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    
    # year 2011-12 data on local directory
    wood_c_pool <- make_wood_c_pool(ring_area=FACE_ring_area,
                                    c_frac=c_fraction,
                                    return_tree_level=FALSE)
    
    
    #### Wood C production
    wood_c_production <- make_wood_production_flux(wood_c_pool)
    
        ### make the plot
    p <- ggplot(wood_c_pool,
                aes(Date, wood_pool, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Wood C (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

<br/>

Wood pool decreases over certain periods for certain rings (e.g. ring 6, 5, 2). I investigated this by looking at the raw diameter data. Notably, only 1 tree was marked as mortality in ring 6 (tree 608); however, we don't know when it died. Raw diameter data indicates that, decrease in diameter is common in the measurements. Hence, mortality is not driving this decrease in wood pool pattern. 

On the other hand, we still need to properly account for mortality, or standing dead pool. Because the data only marked one tree as dead, we need to 1) check if any additional death data is avaialble, and 2) make them a separate pool as dead wood, and make an additional total wood pool. 

Next, wood C production is:

``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    ### make the plot
    p <- ggplot(wood_c_production,
                aes(Date, wood_production_flux, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Wood C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

Because wood pool may either increase or decrease over a certain measurement period, wood production can be either positive or negative. 


# 5. P pools and fluxes

### 5.1 Soil P pool
``` {r, echo=FALSE, warning=FALSE}

    soil_p_pool <- make_soil_p_pool(p_conc=soil_p_concentration,
                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_p_pool,
                aes(Date, soil_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() +
            xlab("Date") + ylab("Soil P pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.2 Soil PO4-P pool
Note, this pool is more readily available to plants as the microbial p pool needs one extra step when extracting.
``` {r, echo=FALSE, warning=FALSE}

    soil_phosphate_pool <- make_soil_phosphate_pool(p_conc=soil_phosphate_concentration,
                                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_phosphate_pool,
                aes(Date, soil_phosphate_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil PO4-P production (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.3 Microbial P pool
Note, this is for top 10 cm of the soil. 
``` {r, echo=FALSE, warning=FALSE}

    microbial_p_pool <- make_microbial_p_pool(p_conc=microbial_p_concentration,
                                              bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(microbial_p_pool,
                aes(Date, microbial_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil PO4-P production (g m-2)")
    plot(p)


```

This pool seems very large, especially consideration its concentration is very small (compared to wood for example). It implies that the biomass is enormous. Checking data description on HIEv, the microbial P concentration was "Fumigation extraction with Bray P AQ2 determination of PO4", in the unit og ug g-1. Essentially, the calculation was done by P conc * soil bulk, not P conc by biomass. Check with Cat to see if this makes sense. 

### 5.4 Canopy P pool
``` {r, echo=FALSE, warning=FALSE}

    canopy_p_pool <- make_canopy_p_pool(p_conc=canopy_p_concentration,
                                        biom=canopy_biomass_pool)

    ### make the plot
    p <- ggplot(canopy_p_pool,
                aes(Date, leaf_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Canopy P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.5 Wood P pool
``` {r, echo=FALSE, warning=FALSE}

    wood_p_pool <- make_wood_p_pool(p_conc=wood_p_concentration,
                                    c_pool=wood_c_pool,
                                    case_consideration="sapwood")

    ### make the plot
    p <- ggplot(wood_p_pool,
                aes(Date, wood_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

We have only concentration measurement for one point in time. Assume this rate applies to all biomass. 
Check, why inconsistent time points. 

### 5.6 Fine root P pool
``` {r, echo=FALSE, warning=FALSE}

    fineroot_p_pool <- make_fineroot_p_pool(p_conc=fineroot_p_concentration,
                                            c_pool=fineroot_c_pool)

    ### make the plot
    p <- ggplot(fineroot_p_pool,
                aes(Date, fineroot_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.7 Coarse root P pool
``` {r, echo=FALSE, warning=FALSE}

    coarse_root_p_pool_1 <- make_coarse_root_p_pool(p_conc=wood_p_concentration,
                                                c_pool=coarse_root_c_pool_1,
                                                c_frac=c_fraction)

    coarse_root_p_pool_2 <- make_coarse_root_p_pool(p_conc=wood_p_concentration,
                                                c_pool=coarse_root_c_pool_2,
                                                c_frac=c_fraction)

    ### make the plot
    p <- ggplot(coarse_root_p_pool_1,
                aes(Date, coarse_root_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Coarse root P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.8 Understorey aboveground P pool
``` {r, echo=FALSE, warning=FALSE}

    understorey_p_pool <- make_understorey_p_pool(p_conc=understorey_p_concentration,
                                              c_pool=understorey_c_pool,
                                              c_frac=c_fraction_ud)

    ### make the plot
    p <- ggplot(understorey_p_pool,
                aes(Date, understorey_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

Understorey P pool, assume both species contributed equally. Also because p_conc and c_pool do not match in time, we are taking the average of p_conc and apply it to c_pool. When Mathias's continuous c_pool data becomes available, we can update this calculation.

### 5.9 Mycorrhizal P pool
Data still not available. 


### 5.10 Canopy P flux
``` {r, echo=FALSE, warning=FALSE}

    canopy_c_production_flux <- leaflitter_c_production_flux

    canopy_p_flux <- make_canopy_p_production(p_conc=canopy_p_concentration,
                                          c_flux=canopy_c_production_flux,
                                          c_frac=c_fraction)

    ### make the plot
    p <- ggplot(canopy_p_flux,
                aes(Date, canopy_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.11 Wood P flux
``` {r, echo=FALSE, warning=FALSE}

    wood_p_flux <- make_wood_p_production(p_conc=wood_p_concentration,
                                    c_flux=wood_c_production)

    ### make the plot
    p <- ggplot(wood_p_flux,
                aes(Date, wood_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.12 Fineroot production P flux
``` {r, echo=FALSE, warning=FALSE}

    fineroot_p_production <- make_fineroot_p_production(p_conc=fineroot_p_concentration,
                                                        c_flux=fineroot_c_production_flux)
    ### make the plot
    p <- ggplot(fineroot_p_production,
                aes(Date, fineroot_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.13 Coarse root production P flux
``` {r, echo=FALSE, warning=FALSE}

    coarse_root_p_flux_1 <- make_coarse_root_p_flux(p_conc=wood_p_concentration,
                                                c_flux=coarse_root_c_flux_1,
                                                c_frac=c_fraction)

    coarse_root_p_flux_2 <- make_coarse_root_p_flux(p_conc=wood_p_concentration,
                                                c_flux=coarse_root_c_flux_2,
                                                c_frac=c_fraction)

    ### make the plot
    p <- ggplot(coarse_root_p_flux_1,
                aes(Date, coarse_root_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Coarse P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```


### 5.14 Leaflitter P flux
``` {r, echo=FALSE, warning=FALSE, message = FALSE}

    leaflitter_p_flux <- make_leaflitter_p_flux(p_conc=leaflitter_p_concentration)  

    ### make the plot
    p <- ggplot(leaflitter_p_flux,
                aes(Date, leaflitter_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Leaf litter P (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p) 


```

### 5.15 Fineroot litter P flux

This is estimated based on fine root c production flux, fineroot p concentration, and an bulk estimate of fine root P retranslocation coefficient. 

``` {r, echo=FALSE, warning=FALSE}

    fineroot_litter_p_flux <- make_fineroot_litter_p_production(p_conc=fineroot_p_concentration,
                                                            c_flux=fineroot_c_production_flux,
                                                            p_retrans=0.5)
    ### make the plot
    p <- ggplot(fineroot_litter_p_flux,
                aes(Date, fineroot_litter_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot Litter P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```


### 5.16 other aboveground litter P flux
``` {r, echo=FALSE, warning=FALSE, message = FALSE}

    other_litter_p_flux <- make_other_litter_p_flux(p_conc=wood_p_concentration)  

    ### make the plot
    p <- ggplot(other_litter_p_flux,
                aes(Date, other_litter_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Other litter P (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.17 Frass production P flux
``` {r, echo=FALSE, warning=FALSE}

    frass_p_production <- make_frass_p_production_flux(p_conc=frass_p_concentration,
                                                   c_flux=frass_c_production_flux,
                                                   c_frac=frass_c_fraction)

    ### make the plot
    p <- ggplot(frass_p_production,
                aes(Date, frass_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Frass P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.18 Understorey production P flux
``` {r, echo=FALSE, warning=FALSE}

    understorey_p_flux <- make_understorey_p_flux(p_conc=understorey_p_concentration,
                                              c_flux=understorey_c_flux,
                                              c_frac=c_fraction_ud)

    ### make the plot
    p <- ggplot(understorey_p_flux,
                aes(Date, understorey_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() +
            xlab("Date") + ylab("Understorey P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

Used Varsha's harvest data to extrapolate. 

### 5.19 Soil mineralization P flux
``` {r, echo=FALSE, warning=FALSE}

    soil_p_mineralization <- make_soil_p_mineralization_flux(soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_p_mineralization,
                aes(date, p_mineralization_mg_m2_d, color=factor(ring))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Soil P mineralization (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

Positive values indicate minerlization, negative indicate immobilization. 



# 6. Summary tables
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    library(knitr)

```
Below, I summarize the per ring, per treatment table for all P concentration variables. 
Rings 2, 3, 6 are ambient CO2 rings, and rings 1, 4, 5 are elevated CO2 rings. 

``` {r, echo=FALSE, warning=FALSE, message=FALSE} 
    source("programs/make_conc_summary_table_by_treatment.R")
    summary_table_concentration_by_treatment <- make_conc_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_concentration_by_treatment)[1] <- "Variable"
    summary_table_concentration_by_treatment[,2:7] <- round(summary_table_concentration_by_treatment[,2:7], 3)
    
    kable(summary_table_concentration_by_treatment)

```

<br/>
<br/>
<br/>
<br/>

Next, I summarize all P pool variables:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/make_pool_summary_table_by_treatment.R")
    summary_table_pool_by_treatment <- make_pool_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_pool_by_treatment)[1] <- "Variable"
    summary_table_pool_by_treatment[,2:7] <- round(summary_table_pool_by_treatment[,2:7], 3)
    
    kable(summary_table_pool_by_treatment)

```

<br/>
<br/>
<br/>
<br/>

Here I am summarizing all the C pools used for P calculations:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    # first, compute the microbial c pool as we will need it for summary purpose
    microbial_c_pool <- make_microbial_c_pool(soil_bulk_density)

    # now make the summary
    source("programs/make_c_pool_summary_table_by_treatment.R")
    summary_table_c_pool_by_treatment <- make_c_pool_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_c_pool_by_treatment)[1] <- "Variable"
    summary_table_c_pool_by_treatment[,2:9] <- round(summary_table_c_pool_by_treatment[,2:9], 1)
    
    kable(summary_table_c_pool_by_treatment)

```

<br/>
<br/>
<br/>
<br/>

Now, I summarize all P flux variables:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/make_flux_summary_table_by_treatment.R")
    summary_table_flux_by_treatment <- make_flux_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_flux_by_treatment)[1] <- "terms"
    summary_table_flux_by_treatment[,2:7] <- round(summary_table_flux_by_treatment[,2:7], 3)
    
    kable(summary_table_flux_by_treatment)

```

<br/>
<br/>
<br/>
<br/>

Now, we need all the C flux variables to make reference of:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/make_c_flux_summary_table_by_treatment.R")
    summary_table_c_flux_by_treatment <- make_c_flux_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_flux_by_treatment)[1] <- "terms"
    summary_table_c_flux_by_treatment[,2:9] <- round(summary_table_c_flux_by_treatment[,2:9], 3)
    
    kable(summary_table_c_flux_by_treatment)

```

<br/>
<br/>
<br/>
<br/>


Here, I summarize all P budgeting variables, in a table:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/make_p_budgeting_variables.R")
    summary_table_p_budgets <- make_p_budgeting_variables()
    
    # make the table looks nicer
    # colnames(summary_table_p_budgets)[1] <- "terms"

    kable(summary_table_p_budgets)

```

Note: total P retranslocation includes leaf and fineroot retranslocation, plus wood P increment and understorey. Understorey part is a guess retranslocation coefficient, as there is no literature value on Microlaena P retranslocation. 

<br/>
<br/>
<br/>
<br/>


# 7. C:P ratios

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>


# 8. To-do list

High priorities:

    - Summarize P concentration using min and max
    - Possibly look at 2015 to see CO2 treatment effect. 
    - Cat re-check microbial extraction procedure
    - Wood C production and pool over time, why negative
    - Create mortality pool, or standing dead pool

<br/> 

Less priorities:

    - Continuous understorey C data (Matthias)
    - Hedley Fractionation, in 2-3 weeks (Cat)
    - Microbial turnover rate (Cat and Johanna, but may not be available soon)
    - Mycorrhizal data for both C and P project (Jeff)
    - Root mortality and turnover for both C and P project (Juan)
    - Canopy turnover 
    - Meteorological data, including soil moisture (HIEv)
    - More valid fine root and coarse root P retranslocation coefficients
    - Understorey respiration from literature, but without a relationship to temperature
    - CH4 data
    - litter pool
    - split aboveground and belowground in summary table

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

# The end.
